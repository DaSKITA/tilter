version: '3.8'
services:
    flask:
        build:
            context: .
            dockerfile: ops/Dockerfile
        container_name: flask
        ports:
        - "5000:5000"
        restart: unless-stopped
        environment:
            MONGODB_DATABASE: tilterdb
            MONGODB_USERNAME: /run/secrets/mongo_user
            MONGODB_PASSWORD: /run/secrets/mongo_password
            MONGODB_PORT: 27017
            MONGODB_HOST: mongo
            DEPLOYMENT: 1
            FLASK_SECRET_KEY: 12345678901234567890123456789012
            FLASK_APP: main.py
            FLASK_DEBUG: 0
            FLASK_ENV: "production"
            JWT_SECRET_KEY: /run/secrets/jwt_secret_key
        # Infinite loop, to keep it alive, for debugging
        # command: bash -c "while true; do echo 'sleeping...' && sleep 10; done"
        secrets:
            - mongo_user
            - mongo_password
        depends_on:
        - mongo

    mongo-express: # DATABASE ADMINISTRATION
        image: mongo-express:0.54
        container_name: mongo-express
        ports:
        - "8081:8081"
        links:
        - mongo
        restart: always # this is necessary since the volume of mongo causes a longer restart
        depends_on:
        - mongo
        environment:
            ME_CONFIG_MONGODB_ADMINUSERNAME: /run/secrets/mongo_user
            ME_CONFIG_MONGODB_ADMINPASSWORD: /run/secrets/mongo_password
            ME_CONFIG_BASICAUTH_USERNAME: admin
            ME_CONFIG_BASICAUTH_PASSWORD: SuperSecret
        secrets:
            - mongo_user
            - mongo_password

    mongo:
        image: mongo:4.4.4
        container_name: mongo
        restart: unless-stopped
        command: mongod --auth
        environment:
            MONGO_INITDB_ROOT_USERNAME: /run/secrets/mongo_user
            MONGO_INITDB_ROOT_PASSWORD: /run/secrets/mongo_password
            MONGO_INITDB_DATABASE: tilterdb
            MONGODB_DATA_DIR: /data/db
            MONDODB_LOG_DIR: /dev/null
        volumes:
            - ./volumes:/data/db
        ports:
            - '27017:27017'
        secrets:
            - mongo_user
            - mongo_password

secrets:
    mongo_user:
        external: true
        name: mongo_user
    mongo_password:
        external: true
        name: mongo_password


# https://docs.docker.com/compose/compose-file/compose-file-v3/#secrets-configuration-reference
# https://stackoverflow.com/questions/42139605/how-do-you-manage-secret-values-with-docker-compose-v3-1/42151570#42151570

