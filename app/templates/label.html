{% extends 'base.html' %}

{% block content %}
    <!-- Include Label Studio stylesheet -->
    <link href="https://unpkg.com/label-studio@0.8.0/build/static/css/main.css" rel="stylesheet">

    <h1>{% block title %} Welcome to TILTer {% endblock %}</h1>
    <h2>This is task "{{ task.name }}"</h2>
    <a href="{{ url_for("tasks") }}"><- task overview</a>

    <!-- Create the Label Studio container -->
    <div id="label-studio"></div>

    <!-- Include the Label Studio library -->
    <script src="https://unpkg.com/label-studio@0.8.0/build/static/js/main.js"></script>

    <!-- Initialize Label Studio -->
    <script>
        const sendAnnotations = async (completion) => {
                        const response = await fetch('{{ target_url }}', {
                            method: "POST",
                            body: JSON.stringify(completion.areas.toJSON()),
                            headers: {
                                "accept": "application/json",
                                "Content-Type": "application/json"
                            }
                        });
                      const content = await response;
                      console.log(content)
                    }

        var labelStudio = new LabelStudio('label-studio', {
            config: `
      <View>
        <Labels name="ner" toName="text"> // type: htmllabels
          {% for label in task.labels %}
            <Label value="{{ label }}"/>
          {% endfor %}
        </Labels>

        <View style="border: 1px solid #CCC;
                     border-radius: 10px;
                     padding: 5px">
          <Text name="text" value="$text" showLabels="true"/>
        </View>
      </View>
      `,

            interfaces: [
                "panel",
                "update",
                "controls",
                "side-column",
//        "completions:menu",
//        "completions:add-new",
//        "completions:delete",
                "predictions:menu",
            ],

            user: {
                pk: 1, //load user auth from db here
                firstName: "James",
                lastName: "Dean"
            },

            task: {
                completions: [{
                    "result": [
                        {% for annotation in annotations %}
                            {
                                "value": {
                                    "start": {{ annotation.start }},
                                    "end": {{ annotation.end }},
                                    "text": "{{ annotation.text }}",
                                    "labels": [
                                        "{{ annotation.label }}"
                                    ]
                                },
                                "id": "{{ annotation.id }}",
                                "from_name": "ner",
                                "to_name": "text",
                                "type": "labels"
                            },
                        {% endfor %}
                    ]
                  }],
                predictions: [],
//                id: 777,
                data: {
                    text: ` {% if task.html %}
                                {{ task.text | html_escape }}
                            {% else %}{{ task.text | txt_escape }}
                                {% endif %}`
                }
            },

            onLabelStudioLoad: function (LS) {
                var c = LS.completionStore.addCompletion({
                    userGenerate: true
                });
                LS.completionStore.selectCompletion(c.id);
            },
            onSubmitCompletion: function (LS, completion) {
                sendAnnotations(completion)
            },
            onUpdateCompletion: function (LS, completion) {
                sendAnnotations(completion)
            }
        });
    </script>
{% endblock %}
